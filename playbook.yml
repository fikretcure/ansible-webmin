---
- name: Webmin kurulumu
  hosts: all
  become: true
  serial: 1

  vars:
    webmin_marker: /tmp/ansible_playbook_done

  tasks:

    - name: Webmin repo durumu kontrolü
      stat:
        path: "{{ webmin_marker }}"
      register: webmin_repo

    - name: Webmin marker durumu (bilgi)
      debug:
        msg: "Webmin daha önce kurulmuş mu? => {{ webmin_repo.stat.exists }}"

    - block:

        - name: Webmin setup scriptini indir (yalnızca yoksa)
          get_url:
            url: https://raw.githubusercontent.com/webmin/webmin/master/webmin-setup-repo.sh
            dest: /tmp/webmin-setup-repo.sh
            mode: '0755'
            force: no

        - name: Webmin setup scriptini çalıştır
          shell: yes | sh /tmp/webmin-setup-repo.sh
          register: webmin_output

        - name: Setup script çıktısını göster
          debug:
            var: webmin_output.stdout_lines

        - name: apt cache'i güncelle
          apt:
            update_cache: yes

        - name: Webmin'i kur
          apt:
            name: webmin
            state: present
            install_recommends: yes

        - name: Webmin servisini başlat ve enable et
          systemd:
            name: webmin
            state: started
            enabled: yes

        - name: Kurulum tamamlandı marker dosyasını oluştur
          file:
            path: "{{ webmin_marker }}"
            state: touch

      when: not webmin_repo.stat.exists
